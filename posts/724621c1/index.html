<!-- build time:Tue Oct 12 2021 10:18:10 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link rel="stylesheet" href="/lib/pace/pace-theme-center-atom.min.css?v=1.0.2"><meta name="google-site-verification" content="4fXg7_br-6EcJkwb-a6Ci2NLdRf7aMleAsM1L9S1nBI"><link rel="stylesheet" href="/lib/fancybox/source/jquery.fancybox.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0"><link rel="stylesheet" href="/css/main.css?v=7.2.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.2.0"><link rel="icon" type="image/png" sizes="32x32" href="/images/2.ico?v=7.2.0"><link rel="icon" type="image/png" sizes="16x16" href="/images/1.ico?v=7.2.0"><link rel="mask-icon" href="/images/logo.svg?v=7.2.0" color="#222"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"7.2.0",sidebar:{position:"left",display:"post",offset:12,onmobile:!1,dimmer:!1},back2top:!0,back2top_sidebar:!0,fancybox:!0,fastclick:!1,lazyload:!1,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><meta name="description" content="4.4网际控制报文协议 ICMP4.4.1ICMP 报文的种类ICMP是（Internet Control Message Protocol）Internet控制报文协议。它是TCP/IP协议族的一个子协议，用于在IP主机、路由器之间传递控制消息。一种面向无连接的协议，用于传输出错报告控制信息，在网络安全方面有广泛应用；ICMP就是一个“错误侦测与回报机制”，其目的就是检测网路的连线状况，确保连线"><meta property="og:type" content="article"><meta property="og:title" content="计算机网络【五】"><meta property="og:url" content="http://lyxf2000.github.io/posts/724621c1/index.html"><meta property="og:site_name" content="乐屿心扉"><meta property="og:description" content="4.4网际控制报文协议 ICMP4.4.1ICMP 报文的种类ICMP是（Internet Control Message Protocol）Internet控制报文协议。它是TCP/IP协议族的一个子协议，用于在IP主机、路由器之间传递控制消息。一种面向无连接的协议，用于传输出错报告控制信息，在网络安全方面有广泛应用；ICMP就是一个“错误侦测与回报机制”，其目的就是检测网路的连线状况，确保连线"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508150434366.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508150828304.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508151612695.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508151650318.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508152522584.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508152859708.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508153638545.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508153906371.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508153920540.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508154306577.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508155926993.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508155938831.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508155954559.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508160037048.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508160051340.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508160110136.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508160614351.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508161023234.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508161118589.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513092651214.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513092830769.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513092849913.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513092947941.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210613211229118.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210613211339627.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513093453944.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513094331948.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513094527201.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513094659832.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210613212027761.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210613212037500.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513095134430.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513095144226.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210412111437685.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513100057175.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513100301625.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513101238693.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513101339993.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513101558613.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513101947782.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513102005337.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513102509511.png"><meta property="og:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513103645771.png"><meta property="og:updated_time" content="2021-10-11T12:59:19.331Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="计算机网络【五】"><meta name="twitter:description" content="4.4网际控制报文协议 ICMP4.4.1ICMP 报文的种类ICMP是（Internet Control Message Protocol）Internet控制报文协议。它是TCP/IP协议族的一个子协议，用于在IP主机、路由器之间传递控制消息。一种面向无连接的协议，用于传输出错报告控制信息，在网络安全方面有广泛应用；ICMP就是一个“错误侦测与回报机制”，其目的就是检测网路的连线状况，确保连线"><meta name="twitter:image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508150434366.png"><link rel="canonical" href="http://lyxf2000.github.io/posts/724621c1/"><script id="page.configurations">CONFIG.page={sidebar:""}</script><title>计算机网络【五】 | 乐屿心扉</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">乐屿心扉</span> <span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">Keep Thinking</h1></div><div class="site-nav-toggle"><button aria-label="切换导航栏"><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-playlist"><a href="/playlist/" rel="section"><i class="menu-item-icon fa fa-fw fa-music"></i><br>歌单</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://lyxf2000.github.io/posts/724621c1/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="峻源"><meta itemprop="description" content="乐于心，乐与心，乐之屿，心扉间"><meta itemprop="image" content="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/avatar.gif"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="乐屿心扉"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">计算机网络【五】</h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2021-04-11 20:42:26" itemprop="dateCreated datePublished" datetime="2021-04-11T20:42:26+08:00">2021-04-11</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2021-10-11 20:59:19" itemprop="dateModified" datetime="2021-10-11T20:59:19+08:00">2021-10-11</time> </span><span class="post-time">&nbsp; | &nbsp; <span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">字数统计:</span> <span class="post-count">9.1k(字)</span> </span><span class="post-time">&nbsp; | &nbsp; <span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">阅读时长≈</span> <span class="post-count">31(分)</span></span><br><p></p></div></header><div class="post-body" itemprop="articleBody"><h3 id="4-4网际控制报文协议-ICMP"><a href="#4-4网际控制报文协议-ICMP" class="headerlink" title="4.4网际控制报文协议 ICMP"></a>4.4网际控制报文协议 ICMP</h3><h4 id="4-4-1ICMP-报文的种类"><a href="#4-4-1ICMP-报文的种类" class="headerlink" title="4.4.1ICMP 报文的种类"></a>4.4.1ICMP 报文的种类</h4><p>ICMP是（Internet Control Message Protocol）Internet控制报文协议。它是TCP/IP协议族的一个子协议，用于在IP主机、路由器之间传递控制消息。一种面向无连接的协议，用于传输出错报告控制信息，在网络安全方面有广泛应用；</p><p>ICMP就是一个“错误侦测与回报机制”，其目的就是检测网路的连线状况，确保连线的准确性，其功能如下：</p><ul><li>侦测远端主机是否存在</li><li>建立及维护路由资料</li><li>重导资料传送路径（ICMP重定向）</li><li>资料流量控制。ICMP在沟通之中，主要是透过不同的类别(Type)与代码(Code) 让机器来识别不同的连线状况</li><li></li></ul><p>为了更有效地转发 IP 数据报和提高交付成功的机会，在网际层使用了网际控制报文协议 ICMP (Internet Control Message Protocol)。</p><p>ICMP 是互联网的标准协议。</p><p>ICMP 允许主机或路由器报告差错情况和提供有关异常情况的报告。</p><p><strong>但 ICMP 不是高层协议（看起来好像是高层协议，因为 ICMP 报文是装在 IP 数据报中，作为其中的数据部分），而是 IP 层的协议。</strong></p><img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508150434366.png" alt="image-20210508150434366" style="zoom:67%"><p><strong>ICMP 报文的种类有两种，即 <em>ICMP 差错报告报文*和 *ICMP 询问报文</em></strong></p><p>ICMP 报文的前 4 个字节是统一的格式，共有三个字段：即类型、代码和检验和。接着的 4 个字节的内容与 ICMP 的类型有关</p><p><strong>ICMP 差错报告报文共有 4 种</strong></p><ul><li>终点不可达</li><li>时间超过</li><li>参数问题</li><li>改变路由（重定向）(Redirect)</li></ul><img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508150828304.png" alt="image-20210508150828304" style="zoom:50%"><blockquote><p><strong>根据之前的ICMP报文的格式图。前8个字节是类型、代码、校验和、和取决于类型部分。</strong></p><p><strong>ICMP的数据部分（长度取决于类型），这里就是ICMP 差错报告报文类型的字节设置。取IP数据报首部+8字节内容。</strong></p><p>帮助理解。</p></blockquote><p>不应发送 I<strong>CMP 差错报告报文</strong>的几种情况：</p><ul><li>对 ICMP 差错报告报文不再发送 ICMP 差错报告报文。</li><li>对第一个分片的数据报片的所有后续数据报片都不发送 ICMP 差错报告报文。</li><li>对具有多播地址的数据报都不发送 ICMP 差错报告报文。</li><li>对具有特殊地址（如127.0.0.0 或 0.0.0.0）的数据报不发送 ICMP 差错报告报文。</li></ul><p><strong>ICMP 询问报文有两种</strong></p><ul><li><p>回送请求和回答报文</p></li><li><p>时间戳请求和回答报文</p></li><li><p>下面的几种 ICMP 报文不再使用：</p></li><li><ul><li>信息请求与回答报文</li><li>掩码地址请求和回答报文</li><li>路由器询问和通告报文</li><li>源点抑制报文</li></ul></li></ul><h4 id="4-4-2ICMP-的应用举例"><a href="#4-4-2ICMP-的应用举例" class="headerlink" title="4.4.2ICMP 的应用举例"></a>4.4.2ICMP 的应用举例</h4><p>PING (Packet InterNet Groper)</p><p>PING 用来测试两个主机之间的连通性。</p><p>PING 使用了 ICMP 回送请求与回送回答报文。</p><p>PING 是应用层直接使用网络层 ICMP 的例子，<strong>它没有通过运输层的 TCP 或UDP。</strong></p><img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508151612695.png" alt="image-20210508151612695" style="zoom:50%"><p><strong>Traceroute 的应用举例</strong></p><p>在 Windows 操作系统中这个命令是 tracert。用来跟踪一个分组从源点到终点的路径。它利用 IP 数据报中的 TTL 字段和 ICMP 时间超过差错报告报文实现对从源点到终点的路径的跟踪。</p><img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508151650318.png" alt="image-20210508151650318" style="zoom:67%"><h3 id="4-5互联网的路由选择协议"><a href="#4-5互联网的路由选择协议" class="headerlink" title="4.5互联网的路由选择协议"></a>4.5互联网的路由选择协议</h3><h4 id="4-5-1有关路由选择协议的几个基本概念"><a href="#4-5-1有关路由选择协议的几个基本概念" class="headerlink" title="4.5.1有关路由选择协议的几个基本概念"></a>4.5.1有关路由选择协议的几个基本概念</h4><p><strong>理想的路由算法</strong></p><p>算法必须是正确的和完整的。</p><p>算法在计算上应简单。</p><p>算法应能适应通信量和网络拓扑的变化，这就是说，要有自适应性。</p><p>算法应具有稳定性。</p><p>算法应是公平的。</p><p>算法应是<strong>最佳的</strong>。</p><p><strong>关于“最佳路由”</strong></p><p><strong>不存在一种绝对的最佳路由算法。所谓“最佳”只能是相对于某一种特定要求下得出的较为合理的选择而已。</strong>实际的路由选择算法，应尽可能接近于理想的算法。 路由选择是个非常复杂的问题它是网络中的所有结点共同协调工作的结果。路由选择的环境往往是不断变化的，而这种变化有时无法事先知道。</p><p><strong>从路由算法的自适应性考虑</strong></p><ul><li><strong>静态路由选择策略</strong>——即<strong>非自适应路由选择</strong>，其特点是简单和开销较小，但不能及时适应网络状态的变化。</li><li><strong>动态路由选择策略</strong>——即<strong>自适应路由选择</strong>，其特点是能较好地适应网络状态的变化，但实现起来较为复杂，开销也比较大。</li></ul><p><strong>分层次的路由选择协议</strong></p><p>互联网采用分层次的路由选择协议。这是因为：</p><p>(1) 互联网的规模非常大。如果让所有的路由器知道所有的网络应怎样到达，则这种路由表将非常大，处理起来也太花时间。而所有这些路由器之间交换路由信息所需的带宽就会使互联网的通信链路饱和。</p><p>(2) 许多单位不愿意外界了解自己单位网络的布局细节和本部门所采用的路由选择协议（这属于本部门内部的事情），但同时还希望连接到互联网上。</p><p><strong>自治系统 AS (Autonomous System)</strong></p><p><strong>自治系统 AS 的定义：</strong>在单一的技术管理下的一组路由器，而这些路由器使用一种 AS 内部的路由选择协议和共同的度量以确定分组在该 AS 内的路由，同时还使用一种 AS 之间的路由选择协议用以确定分组在 AS之间的路由。</p><p>现在对自治系统 AS 的定义是强调下面的事实：尽管一个 AS 使用了多种内部路由选择协议和度量，但<strong>重要的是一个 AS 对其他 AS 表现出的是一个单一的和一致的路由选择策略。</strong></p><img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508152522584.png" alt="image-20210508152522584" style="zoom:67%"><p>互联网有两大类路由选择协议</p><p><strong><u>内部网关协议 IGP (Interior Gateway Protocol)</u></strong></p><ul><li>在一个自治系统<strong>内部使用</strong>的路由选择协议。</li><li><strong>目前这类路由选择协议使用得最多，如 <em>RIP</em> 和 <em>OSPF</em> 协议。</strong></li></ul><p><strong><u>外部网关协议 EGP (External Gateway Protocol)</u></strong></p><ul><li><p>若源站和目的站处在不同的自治系统中，当数据报传到一个自治系统的边界时，就需要使用一种协议<strong>将路由选择信息传递到另一个自治系统中。</strong>这样的协议就是外部网关协议 EGP。</p></li><li><p>在外部网关协议中目前使用最多的是 <strong><em>BGP-4</em></strong>。</p></li></ul><img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508152859708.png" alt="image-20210508152859708" style="zoom:67%"><p><strong><u>互联网的早期 RFC 文档中未使用“路由器”而是使用“网关”这一名词。但是在新的 RFC 文档中又使用了“路由器”这一名词。应当把这两个术语当作同义词。</u></strong></p><p>IGP 和 EGP 是协议类别的名称。但 RFC 在使用 EGP 这个名词时出现了一点混乱，因为最早的一个外部网关协议的协议名字正好也是 EGP。因此在遇到名词 EGP 时，应弄清它是指旧的协议 EGP 还是指外部网关协议 EGP 这个类别。</p><h4 id="4-5-2-内部网关协议-RIP"><a href="#4-5-2-内部网关协议-RIP" class="headerlink" title="4.5.2  内部网关协议 RIP"></a>4.5.2 内部网关协议 RIP</h4><p>路由信息协议 RIP (Routing Information Protocol) 是内部网关协议 IGP 中最先得到广泛使用的协议。RIP 是一种分布式的、基于距离向量的路由选择协议。RIP 协议要求网络中的每一个路由器都要维护从它自己到其他每一个目的网络的距离记录。</p><p><strong>“距离”的定义</strong></p><p>从一个路由器到<strong>直接连接</strong>的网络的距离定义为 1。</p><p>从一个路由器到非直接连接的网络的距离定义为所经过的路由器数加 1。</p><p>RIP 协议中的“距离”也称为<strong>“跳数”(hop count)</strong>，因为每经过一个路由器，跳数就加 1。</p><p>这里的“距离”实际上指的是<strong>“最短距离”</strong>。</p><p>RIP 认为一个<strong>好的路由</strong>就是它通过的路由器的数目少，即“距离短”。</p><p><strong>RIP 允许一条路径最多只能包含 15 个路由器。</strong></p><p><strong>“距离”的最大值为 16 时即相当于不可达。</strong>可见 RIP 只适用于小型互联网。</p><p><strong>RIP 不能在两个网络之间同时使用多条路由。</strong>RIP 选择一个具有最少路由器的路由（即最短路由），哪怕还存在另一条高速(低时延)但路由器较多的路由。</p><p><strong>RIP 协议的三个特点</strong></p><ul><li><strong><em>仅和相邻路由器交换信息。</em></strong></li><li><strong><em>交换的信息是当前本路由器所知道的全部信息，即自己的路由表。</em></strong></li><li><strong><em>按固定的时间间隔交换路由信息，例如，每隔 30 秒。当网络拓扑发生变化时，路由器也及时向相邻路由器通告拓扑变化后的路由信息。</em></strong></li></ul><p><strong>路由表的建立</strong></p><p>路由器在<strong>刚刚开始工作时</strong>，只知道到直接连接的网络的距离（此距离定义为 1）。它的<strong>路由表是空的。</strong></p><p>以后，每一个路由器也只和数目非常有限的相邻路由器交换并更新路由信息。</p><p>经过若干次更新后，所有的路由器最终都会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器的地址。</p><p><strong>RIP 协议的收敛 (convergence) 过程较快。“收敛”就是在自治系统中所有的结点都得到正确的路由选择信息的过程。</strong></p><p><strong>距离向量算法</strong></p><img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508153638545.png" alt="image-20210508153638545" style="zoom:50%"><ul><li>RIP 协议让互联网中的所<strong>有路由器都和自己的相邻路由器不断交换路由信息，并不断更新其路由表，使得从每一个路由器到每一个目的网络的路由都是最短的（即跳数最少）</strong></li><li>虽然所有的路由器最终都拥有了整个自治系统的全局路由信息，<strong>但由于每一个路由器的位置不同，它们的路由表当然也应当是不同的</strong></li></ul><img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508153906371.png" alt="image-20210508153906371" style="zoom:50%"> <img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508153920540.png" alt="image-20210508153920540" style="zoom:50%"><p><strong>RIP2 协议的报文格式</strong></p><img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508154306577.png" alt="image-20210508154306577" style="zoom:67%"><p>RIP2 报文<strong>由首部和路由部分组成。</strong></p><p>RIP2 报文中<strong>的路由部分由若干个路由信息组成。</strong>每个<strong>路由信息需要用 20 个字节。</strong>地址族标识符（又称为<strong>地址类别</strong>）字段用来标志所使用的地址协议。</p><p><strong>路由标记填入自治系统的号码</strong>，这是<strong>考虑使 RIP 有可能收到本自治系统以外的路由选择信息</strong>。</p><p>再后面指出某个网络地址、该网络的子网掩码、下一跳路由器地址以及到此网络的距离。</p><p>一个 RIP 报文最多可包括 25 个路由，因而 RIP 报文的最大长度是 <strong>4+20 x25=504 字节。</strong>如超过，必须再用一个 RIP 报文来传送。</p><p>RIP2 具有简单的鉴别功能。若使用鉴别功能，则将原来写入第一个路由信息（20 个字节）的位置用作鉴别。在鉴别数据之后才写入路由信息，但这时最多只能再放入 24 个路由信息。</p><p><strong>RIP 协议特点：好消息传播得快，坏消息传播得慢。</strong></p><p><strong>RIP 存在的一个问题：当网络出现故障时，要经过比较长的时间 (例如数分钟) 才能将此信息传送到所有的路由器。</strong></p><img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508155926993.png" alt="image-20210508155926993" style="zoom:67%"> <img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508155938831.png" alt="image-20210508155938831" style="zoom:67%"> <img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508155954559.png" alt="image-20210508155954559" style="zoom:67%"> <img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508160037048.png" alt="image-20210508160037048" style="zoom:67%"> <img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508160051340.png" alt="image-20210508160051340" style="zoom:67%"> <img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508160110136.png" alt="image-20210508160110136" style="zoom:67%"><blockquote><p>这就是好消息传播得快，而坏消息传播得慢。网络出故障的传播时间往往需要较长的时间(例如数分钟)。这是 RIP 的一个主要缺点。</p></blockquote><p><strong>RIP 协议的优缺点</strong></p><p><strong>优点：</strong></p><ul><li>实现简单，开销较小。</li></ul><p><strong>缺点：</strong></p><ul><li>RIP 限制了网络的规模，它能使用的最大距离为 15（16 表示不可达）</li><li>路由器之间交换的路由信息是路由器中的完整路由表，因而随着网络规模的扩大，开销也就增加。</li><li>“坏消息传播得慢”，使更新过程的收敛时间过长</li></ul><h4 id="4-5-3内部网关协议-OSPF"><a href="#4-5-3内部网关协议-OSPF" class="headerlink" title="4.5.3内部网关协议 OSPF"></a>4.5.3内部网关协议 OSPF</h4><p><strong>开放最短路径优先 OSPF (Open Shortest Path First)</strong>是为克服 RIP 的缺点在 1989 年开发出来的。OSPF 的原理很简单，但实现起来却较复杂。</p><ul><li>“开放”表明 OSPF 协议不是受某一家厂商控制，而是公开发表的。</li><li>“最短路径优先”是因为使用了 Dijkstra 提出的最短路径算法 SPF</li><li>采用分布式的链路状态协议 (link state protocol)。</li><li><strong>注意：OSPF 只是一个协议的名字，它并不表示其他的路由选择协议不是“最短路径优先”。</strong></li></ul><p><strong>三个要点</strong></p><ul><li><p><strong>向本自治系统中所有路由器发送信息</strong>，这里使用的方法是<strong><u>洪泛法</u></strong></p></li><li><p><strong>发送的信息就是与本路由器相邻的所有路由器的链路状态，但这<u>只是路由器所知道的部分信息</u></strong></p></li><li><ul><li><strong>“链路状态”就是说明本路由器都和哪些路由器相邻，以及该链路的“度量”(metric)。</strong></li></ul></li><li><p><strong><em>只有当链路状态发生变化时</em>，路由器才用洪泛法向所有路由器发送此信息。</strong></p></li></ul><p><strong>链路状态数据库</strong></p><ul><li>由于各路由器之间频繁地交换链路状态信息，因此所有的路由器最终都能建立一个链路状态数据库</li><li><strong>这个数据库实际上就是全网的拓扑结构图，它在全网范围内是一致的（这称为链路状态数据库的同步）</strong></li><li>OSPF 的链路状态数据库能较快地进行更新，使各个路由器能及时更新其路由表</li><li><strong>OSPF 的更新过程收敛得快是其重要优点</strong></li></ul><p><strong>OSPF 的区域</strong></p><ul><li>为了使 OSPF 能够用于规模很大的网络，<strong>OSPF 将一个自治系统再划分为若干个更小的范围，叫做区域</strong></li><li>每一个区域都有一个 32 位的区域标识符（用点分十进制表示）</li><li>区域也不能太大，在一个区域内的路由器最好不超过 200 个</li></ul><img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508160614351.png" alt="image-20210508160614351" style="zoom:67%"><p><strong><u>划分区域的好处就是将利用洪泛法交换链路状态信息的范围局限于每一个区域而不是整个的自治系统，这就减少了整个网络上的通信量。</u></strong></p><p><strong>在一个区域内部的路由器只知道本区域的完整网络拓扑，而不知道其他区域的网络拓扑的情况。</strong></p><p><strong>OSPF 使用层次结构的区域划分。在上层的区域叫做主干区域 (backbone area)。</strong></p><p><strong>主干区域的标识符规定为0.0.0.0。主干区域的作用是用来连通其他在下层的区域。</strong></p><ul><li><u><strong>主干路由器：R3、R4、R5、R6、R7</strong></u><ul><li><u><strong>区域边界路由器：R3、R4、R7</strong></u></li></ul></li></ul><p><strong>OSPF 直接用 IP 数据报传送</strong></p><ul><li>OSPF 不用 UDP 而是直接用 IP 数据报传送</li><li>OSPF 构成的数据报很短。这样做可减少路由信息的通信量</li><li>数据报很短的另一好处是可以不必将长的数据报分片传送</li><li>但分片传送的数据报只要丢失一个，就无法组装成原来的数据报，而整个数据报就必须重传</li></ul><p><strong>OSPF 的其他特点</strong></p><p>OSPF 对不同的链路可根据 IP 分组的不同服务类型 TOS 而设置成不同的代价。因此，OSPF 对于不同类型的业务可计算出不同的路由。</p><p>如果到同一个目的网络有多条相同代价的路径，那么可以将通信量分配给这几条路径。这叫做多路径间的负载平衡。</p><p>所有在 OSPF 路由器之间交换的分组都具有鉴别的功能。</p><p>支持可变长度的子网划分和无分类编址 CIDR。</p><p>每一个链路状态都带上一个 32 位的序号，序号越大状态就越新。</p><img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508161023234.png" alt="image-20210508161023234" style="zoom:67%"><p><strong>OSPF 的五种分组类型</strong></p><ul><li>类型1，问候 (Hello) 分组。</li><li>类型2，数据库描述 (Database Description) 分组。</li><li>类型3，链路状态请求 (Link State Request) 分组。</li><li>类型4，链路状态更新 (Link State Update) 分组，用洪泛法对全网更新链路状态。</li><li>类型5，链路状态确认 (Link State Acknowledgment)分组。</li></ul><img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210508161118589.png" alt="image-20210508161118589" style="zoom:67%"><p><strong>OSPF 的其他特点</strong></p><p>OSPF 还规定每隔一段时间，如 30 分钟，要刷新一次数据库中的链路状态。</p><p>由于<strong>一个路由器的链路状态只涉及到与相邻路由器的连通状态，因而与整个互联网的规模并无直接关系</strong>。<strong>因此当互联网规模很大时，OSPF 协议要比距离向量协议 RIP 好得多。</strong></p><p><strong>OSPF 没有“坏消息传播得慢”的问题</strong>，据统计，其响应网络变化的时间小于 100 ms。</p><p><strong>指定的路由器</strong></p><p>多点接入的局域网采用了指定的路由器 (designated router) 的方法，使广播的信息量大大减少。指定的路由器代表该局域网上所有的链路向连接到该网络上的各路由器发送状态信息。</p><h4 id="4-5-4-外部网关协议BGP"><a href="#4-5-4-外部网关协议BGP" class="headerlink" title="4.5.4 外部网关协议BGP"></a>4.5.4 外部网关协议BGP</h4><ul><li><p>BGP 是不同自治系统的路由器之间交换路由信息的协议</p></li><li><p>BGP 较新版本是 2006 年 1 月发表的 BGP-4（BGP 第 4 个版本），即 RFC 4271 ~ 4278</p></li><li><p>可以将 BGP-4 简写为 BGP</p></li><li><p><strong>互联网的规模太大，使得自治系统之间路由选择非常困难。对于自治系统之间的路由选择，要寻找最佳路由是很不现实的</strong></p></li><li><ul><li><strong>当一条路径通过几个不同 AS 时，要想对这样的路径计算出有意义的代价是不太可能的</strong></li><li><strong>比较合理的做法是在 AS 之间交换“可达性”信息</strong></li></ul></li><li><p><strong>自治系统之间的路由选择必须考虑有关策略因此，边界网关协议 BGP 只能是力求寻找一条能够到达目的网络且比较好的路由（不能兜圈子），而并非要寻找一条最佳路由。</strong></p></li></ul><p><strong>BGP 发言人</strong></p><ul><li>每一个自治系统的管理员要选择至少一个路由器作为该自治系统的“ BGP 发言人” (BGP speaker)</li><li>一般说来，两个 BGP 发言人都是通过一个共享网络连接在一起的，而 BGP 发言人往往就是 BGP 边界路由器，但也可以不是 BGP 边界路由器。</li></ul><p><strong>BGP 交换路由信息</strong></p><ul><li>一个 BGP 发言人与其他自治系统中的 BGP 发言人要交换路由信息，就要先建立 <strong>TCP 连接</strong>，然后在此连接上交换 BGP 报文以建立 BGP 会话(session)，利用 BGP 会话交换路由信息</li><li>使用 TCP 连接能提供可靠的服务，也简化了路由选择协议</li><li>使用 TCP 连接交换路由信息的两个 BGP 发言人，彼此成为对方的邻站(neighbor)或对等站(peer)</li></ul><img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513092651214.png" alt="image-20210513092651214" style="zoom:67%"> <img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513092830769.png" alt="image-20210513092830769" style="zoom:67%"> <img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513092849913.png" alt="image-20210513092849913" style="zoom:67%"><p><strong>BGP-4 共使用四种报文</strong></p><ul><li>打开 (OPEN) 报文，用来与相邻的另一个BGP发言人建立关系</li><li>更新 (UPDATE) 报文，用来发送某一路由的信息，以及列出要撤消的多条路由\</li><li>保活 (KEEPALIVE) 报文，用来确认打开报文和周期性地证实邻站关系</li><li>通知 (NOTIFICATION) 报文，用来发送检测到的差错</li></ul><img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513092947941.png" alt="image-20210513092947941" style="zoom:67%"><h4 id="三种协议的比较"><a href="#三种协议的比较" class="headerlink" title="三种协议的比较"></a>三种协议的比较</h4><p><img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210613211229118.png" alt="image-20210613211229118"></p><img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210613211339627.png" alt="image-20210613211339627" style="zoom:67%"><h4 id="4-5-5-路由器的构成"><a href="#4-5-5-路由器的构成" class="headerlink" title="4.5.5  路由器的构成"></a>4.5.5 路由器的构成</h4><p>路由器是一种典型的网络层设备。</p><p>路由器是互联网中的关键设备。</p><p>路由器的主要作用是：</p><ul><li>连通不同的网络。</li><li>选择信息传送的线路。选择通畅快捷的近路，能大大提高通信速度，减轻网络系统通信负荷，节约网络系统资源，提高网络系统畅通率，从而让网络系统发挥出更大的效益来。</li></ul><img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513093453944.png" alt="image-20210513093453944" style="zoom:80%"><p>整个的路由器结构可划分为两大部分：</p><ul><li>路由选择部分</li><li>分组转发部分</li></ul><p><strong>路由选择部分</strong></p><p>也叫做控制部分，其核心构件是路由选择处理机。</p><p>路由选择处理机的任务是<strong><u>根据所选定的路由选择协议</u><em>构造出路由表</em></strong>，<strong>同时经常或定期地和相邻路由器交换路由信息而不断地更新和维护路由表。</strong></p><p><strong>分组转发部分由三部分组成</strong></p><p>交换结构 (switching fabric)：又称为交换组织，其作用是根据转发表 (forwarding table) 对分组进行处理。</p><p>一组输入端口</p><p>一组输出端口</p><p><strong>“转发”和“路由选择”的区别</strong></p><p><strong>“转发”(forwarding) 就是路由器根据转发表将用户的 IP 数据报从合适的端口转发出去。</strong></p><p><strong>“路由选择”(routing) 则是按照分布式算法，根据从各相邻路由器得到的关于网络拓扑的变化情况，动态地改变所选择的路由。</strong></p><p><strong>路由表是根据路由选择算法得出的。而转发表是从路由表得出的。</strong></p><p><strong>在讨论路由选择的原理时，往往不去区分转发表和路由表的区别。</strong></p><p><strong>输入端口对线路上收到的分组的处理</strong></p><p>路由器的输入端口里面装有物理层、数据链路层和网络层的处理模块。</p><p>数据链路层剥去帧首部和尾部后，将分组送到网络层的队列中排队等待处理。这会产生一定的时延。</p><p><strong>输入端口中的查找和转发功能在路由器的交换功能中是最重要的。</strong></p><img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513094331948.png" alt="image-20210513094331948" style="zoom:67%"><p>输出端口将交换结构传送来的分组发送到线路</p><p>输出端口里面装有物理层、数据链路层和网络层的处理模块。</p><p>输出端口从交换结构接收分组，然后把它们发送到路由器外面的线路上。</p><p>在网络层的处理模块中设有一个缓冲区（队列）。当交换结构传送过来的分组的速率超过输出链路的发送速率时，来不及发送的分组就必须暂时存放在这个队列中。</p><p>数据链路层处理模块将分组加上链路层的首部和尾部，交给物理层后发送到外部线路。</p><img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513094527201.png" alt="image-20210513094527201" style="zoom:67%"><p><strong>分组丢弃</strong></p><p>若路由器处理分组的速率赶不上分组进入队列的速率，则队列的存储空间最终必定减少到零，这就使后面再进入队列的分组由于没有存储空间而只能被丢弃。</p><p><strong>路由器中的输入或输出队列产生溢出是造成分组丢失的重要原因。</strong></p><p><strong>交换结构</strong></p><p>交换结构是路由器的关键构件。</p><p>正是这个交换结构把分组从一个输入端口转移到某个合适的输出端口。</p><p>实现交换有多种方法。常用交换方法有三种：</p><ul><li>(1) 通过存储器</li><li>(2) 通过总线</li><li>(3) 通过纵横交换结构</li></ul><img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513094659832.png" alt="image-20210513094659832" style="zoom:50%"><blockquote><img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210613212027761.png" alt="image-20210613212027761" style="zoom:67%"> <img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210613212037500.png" alt="image-20210613212037500" style="zoom:67%"></blockquote><h3 id="4-6-IPv6"><a href="#4-6-IPv6" class="headerlink" title="4.6 IPv6"></a>4.6 IPv6</h3><p>地址缩写：</p><ul><li><strong>允许把数字前面的 0 省略。</strong><ul><li>0000 中的前三个 0 省略，写成 1 个 0。</li></ul></li><li><strong>一连串连续的零可以为一对冒号所取代。</strong><ul><li>注意：在任一地址中只能使用一次零压缩。</li></ul></li></ul><h3 id="4-7-IP-多播"><a href="#4-7-IP-多播" class="headerlink" title="4.7 IP 多播"></a>4.7 IP 多播</h3><h4 id="4-7-1-IP-多播的基本概念"><a href="#4-7-1-IP-多播的基本概念" class="headerlink" title="4.7.1  IP 多播的基本概念"></a>4.7.1 IP 多播的基本概念</h4><p>IP 多播 (multicast，以前曾译为组播) 已成为互联网的一个热门课题。</p><p>目的：更好地支持一对多通信。</p><p>一对多通信：一个源点发送到许多个终点。</p><p>例如，实时信息的交付（如新闻、股市行情等），软件更新，交互式会议及其他多媒体通信。</p><img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513095134430.png" alt="image-20210513095134430" style="zoom:67%"> <img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513095144226.png" alt="image-20210513095144226" style="zoom:67%"><p>在互联网上进行多播就叫做 <strong>IP 多播。</strong>互联网范围的多播要靠路由器来实现。</p><p>能够运行多播协议的路由器称为多播路由器(multicast router)。当然它也可以转发普通的单播IP数据报。</p><p>IP 多播所传送的分组需要使用<strong>多播 IP 地址</strong>。</p><p>在多播数据报的目的地址写入的是<strong>多播组</strong>的标识符。</p><p><strong>多播组的标识符就是 IP 地址中的 D 类地址（多播地址）。</strong></p><p><strong>每一个 D 类地址标志一个多播组。</strong></p><p><strong>多播地址只能用于目的地址，不能用于源地址。</strong></p><img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210412111437685.png" alt="image-20210412111437685" style="zoom:60%"><p>多播数据报和一般的 IP 数据报的区别就是它使用 D 类 IP 地址作为目的地址，并且首部中的协议字段值是 2，表明使用网际组管理协议 IGMP。</p><p>多播数据报也是“尽最大努力交付”，不保证一定能够交付多播组内的所有成员。</p><p>对多播数据报不产生 ICMP 差错报文。因此，若在 PING 命令后面键入多播地址，将永远不会收到响应。</p><h4 id="4-7-2-在局域网上进行硬件多播"><a href="#4-7-2-在局域网上进行硬件多播" class="headerlink" title="4.7.2  在局域网上进行硬件多播"></a>4.7.2 在局域网上进行硬件多播</h4><p>*<em>D 类 IP 地址与以太网多播地址的映射关系 *</em></p><p>互联网号码指派管理局 IANA 拥有的以太网地址块的高 24 位为 00-00-5E。</p><p>因此 TCP/IP 协议使用的以太网地址块的范围是</p><p>​ 从 00-00-5E-00-00-00</p><p>​ 到 00-00-5E-FF-FF-FF</p><p>不难看出，在每一个地址中，只有23位可用作多播。</p><p>D 类 IP 地址可供分配的有 28 位，在这 28 位中的前 5 位不能用来构成以太网硬件地址。</p><img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513100057175.png" alt="image-20210513100057175" style="zoom:67%"><p>由于多播 IP 地址与以太网硬件地址的映射关系不是唯一的，因此收到多播数据报的主机，还要在 IP 层利用软件进行过滤，把不是本主机要接收的数据报丢弃。</p><h4 id="4-7-3-网际组管理协议-IGMP-和多播路由选择协议"><a href="#4-7-3-网际组管理协议-IGMP-和多播路由选择协议" class="headerlink" title="4.7.3  网际组管理协议 IGMP 和多播路由选择协议"></a>4.7.3 网际组管理协议 IGMP 和多播路由选择协议</h4><p>为了使路由器知道多播组成员的信息，需要利用网际组管理协议 IGMP (Internet Group Management Protocol)。</p><p>连接在局域网上的多播路由器还必须和互联网上的其他多播路由器协同工作，以便把多播数据报用最小代价传送给所有的组成员。这就需要使用多播路由选择协议。</p><p><img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513100301625.png" alt="image-20210513100301625"></p><p><strong>IGMP 的使用范围</strong></p><p>IGMP 并非在互联网范围内对所有多播组成员进行管理的协议。</p><p>IGMP 不知道 IP 多播组包含的成员数，也不知道这些成员都分布在哪些网络上。</p><p>IGMP 协议是让连接在本地局域网上的多播路由器知道本局域网上是否有主机（严格讲，是主机上的某个进程）参加或退出了某个多播组。</p><p><strong>多播路由选择协议更为复杂</strong></p><p>多播转发必须动态地适应多播组成员的变化（这时网络拓扑并未发生变化）。请注意，单播路由选择通常是在网络拓扑发生变化时才需要更新路由。</p><p>多播路由器在转发多播数据报时，不能仅仅根据多播数据报中的目的地址，而是还要考虑这个多播数据报从什么地方来和要到什么地方去。</p><p>多播数据报可以由没有加入多播组的主机发出，也可以通过没有组成员接入的网络。</p><p><strong>IGMP 是整个网际协议 IP 的一个组成部分</strong></p><p>和 ICMP 相似，IGMP 使用 IP 数据报传递其报文（即 IGMP 报文加上 IP 首部构成 IP 数据报），但它也向 IP 提供服务。</p><p>因此，我们不把 IGMP 看成是一个单独的协议，而是属于整个网际协议 IP 的一个组成部分。</p><p>IGMP 工作：略</p><p>IGMP 采用的一些具体措施：略</p><p><strong>多播路由选择</strong></p><p>多播路由选择协议尚未标准化。一个多播组中的成员是动态变化的，随时会有主机加入或离开这个多播组。</p><p><strong>多播路由选择实际上就是要找出以源主机为根结点的多播转发树。</strong>在多播转发树上的路由器不会收到重复的多播数据报。对不同的多播组对应于不同的多播转发树。同一个多播组，对不同的源点也会有不同的多播转发树。</p><p>多播路由选择协议在转发多播数据报时使用三种方法：</p><p>(1) 洪泛与剪除</p><p>(2) 隧道技术 (tunneling)</p><p>(3) 基于核心的发现技术</p><p><strong>洪泛与剪除</strong></p><p>这种方法适合于较小的多播组，而所有的组成员接入的局域网也是相邻接的。一开始，路由器转发多播数据报使用洪泛的方法（这就是广播）。</p><p><strong>为了避免兜圈子，采用了叫做反向路径广播 RPB (Reverse Path Broadcasting) 的策略。</strong></p><ul><li>RPB 的要点<ul><li>路由器收到多播数据报时，先检查它是否是从源点经最短路径传送来的。</li><li>若是，就向所有其他方向转发刚才收到的多播数据报（但进入的方向除外），否则就丢弃而不转发。</li><li>如果存在几条同样长度的最短路径，那么只能选择一条最短路径，选择的准则就是看这几条最短路径中的相邻路由器谁的 IP 地址最小。</li><li>最后就得出了用来转发多播数据报的多播转发树，以后就按这个多播转发树转发多播数据报。避免了多播数据</li><li>报的兜圈子，同时每一个路由器也不会接收重复的多播数据报。</li><li>如果在多播转发树上的某个路由器发现它的下游树枝（即叶节点方向）已没有该多播组的成员，就应把它和下游的树枝一起剪除。</li><li>当某个树枝有新增加的组成员时，可以再接入到多播转发树上。</li></ul></li></ul><img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513101238693.png" alt="image-20210513101238693" style="zoom:67%"><p>*<em>隧道技术 (tunneling) *</em></p><img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513101339993.png" alt="image-20210513101339993" style="zoom:67%"><p><strong>其实就是把多播数据转为单播数据直接传过去</strong></p><p><strong>基于核心的发现技术</strong></p><p>这种方法对于多播组的大小在较大范围内变化时都适合。</p><p>这种方法是对每一个多播组 G 指定一个核心(core) 路由器，给出它的 IP 单播地址。</p><p>核心路由器按照前面讲过的方法创建出对应于多播组 G 的转发树。</p><h3 id="4-8虚拟专用网-VPN-和网络地址转换-NAT"><a href="#4-8虚拟专用网-VPN-和网络地址转换-NAT" class="headerlink" title="4.8虚拟专用网 VPN 和网络地址转换 NAT"></a>4.8虚拟专用网 VPN 和网络地址转换 NAT</h3><h4 id="4-8-1-虚拟专用网-VPN"><a href="#4-8-1-虚拟专用网-VPN" class="headerlink" title="4.8.1  虚拟专用网 VPN"></a>4.8.1 虚拟专用网 VPN</h4><p>由于 IP 地址的紧缺，一个机构能够申请到的IP地址数往往远小于本机构所拥有的主机数。</p><p>考虑到互联网并不很安全，一个机构内也并不需要把所有的主机接入到外部的互联网。</p><p>假定在一个机构内部的计算机通信也是采用 TCP/IP 协议，那么从原则上讲，对于这些仅在机构内部使用的计算机就可以由本机构自行分配其 IP 地址。</p><p>本地地址——仅在机构内部使用的 IP 地址，可以由本机构自行分配，而不需要向互联网的管理机构申请。</p><p>全球地址——全球唯一的 IP 地址，必须向互联网的管理机构申请。</p><p>问题：在内部使用的本地地址就有可能和互联网中某个 IP 地址重合，这样就会出现地址的二义性问题。</p><p>解决：RFC 1918 指明了一些专用地址 (private address)。专用地址只能用作本地地址而不能用作全球地址。<strong>在互联网中的所有路由器，对目的地址是专用地址的数据报一律不进行转发。</strong></p><img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513101558613.png" alt="image-20210513101558613" style="zoom:67%"><p>采用这样的专用 IP 地址的互连网络称为专用互联网或本地互联网，或更简单些，就叫做专用网。</p><p>因为这些专用地址仅在本机构内部使用。专用IP地址也叫做可重用地址 (reusable address)。</p><p><strong>利用公用的互联网作为本机构各专用网之间的通信载体，这样的专用网又称为虚拟专用网VPN (Virtual Private Network)。</strong></p><p>“专用网”是因为这种网络是为本机构的主机用于机构内部的通信，而不是用于和网络外非本机构的主机通信。</p><p>“虚拟”表示“好像是”，但实际上并不是，因为现在并没有真正使用通信专线，而VPN只是在效果上和真正的专用网一样。</p><p>如果专用网不同网点之间的通信必须经过公用的互联网，但又有保密的要求，那么所有通过互联网传送的数据都必须加密。</p><p>一个机构要构建自己的 VPN 就必须为它的每一个场所购买专门的硬件和软件，并进行配置，使每一个场所的 VPN 系统都知道其他场所的地址。</p><img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513101947782.png" alt="image-20210513101947782" style="zoom:80%"> <img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513102005337.png" alt="image-20210513102005337" style="zoom:67%"><p>远程接入 VPN (remote access VPN)可以满足外部流动员工访问公司网络的需求。</p><p>在外地工作的员工拨号接入互联网，而驻留在员工 PC 机中的 <strong>VPN 软件可在员工的 PC 机和公司的主机之间建立 VPN 隧道，</strong>因而外地员工与公司通信的内容是保密的，员工们感到好像就是使用公司内部的本地网络。</p><h4 id="4-8-2-网络地址转换-NAT"><a href="#4-8-2-网络地址转换-NAT" class="headerlink" title="4.8.2   网络地址转换 NAT"></a>4.8.2 网络地址转换 NAT</h4><p>问题：在专用网上使用专用地址的主机如何与互联网上的主机通信（并不需要加密）？</p><p>解决：</p><ul><li>再申请一些全球 IP 地址。但这在很多情况下是不容易做到的。</li><li>采用网络地址转换 NAT。这是目前使用得最多的方法。</li></ul><p>网络地址转换 NAT (Network Address Translation) 方法于1994年提出。</p><p>需要在专用网连接到互联网的路由器上安装 NAT 软<strong>件。装有 NAT 软件的路由器叫做 NAT路由器，它至少有一个有效的外部全球IP地址。</strong></p><p>所有使用本地地址的主机在和外界通信时，都<strong>要在 NAT 路由器上将其本地地址转换成全球 IP 地址，才能和互联网连接。</strong></p><blockquote><p>PS：这才是我们家用路由器的真正内容。</p><p>家用的是“虚假的路由器”，其实就是给你收发数据套上全球IP地址接入互联网。</p></blockquote><img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513102509511.png" alt="image-20210513102509511" style="zoom:67%"><p>当 NAT 路由器具有 n 个全球 IP 地址时，专用网内最多可以同时有 n 台主机接入到互联网。这样就可以使专用网内较多数量的主机，轮流使用 NAT 路由器有限数量的全球 IP 地址。</p><p>通过 NAT 路由器的通信必须由专用网内的主机发起。专用网内部的主机不能充当服务器用，因为互联网上的客户无法请求专用网内的服务器提供服务。</p><p>为了更加有效地利用 NAT 路由器上的全球IP地址，现在常用的 NAT 转换表把运输层的端口号也利用上。这样，就可以使<strong>多个拥有本地地址的主机，共用一个 NAT 路由器上的全球 IP 地址，因而可以同时和互联网上的不同主机进行通信。</strong></p><p><strong>使用端口号的 NAT 叫做网络地址与端口号转换NAPT (Network Address and Port Translation)，而不使用端口号的 NAT 就叫做传统的 NAT (traditional NAT)。</strong></p><p><img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/image-20210513103645771.png" alt="image-20210513103645771"></p><h3 id="4-9-多协议标记交换-MPLS"><a href="#4-9-多协议标记交换-MPLS" class="headerlink" title="4.9 多协议标记交换 MPLS"></a>4.9 多协议标记交换 MPLS</h3><p>IETF于1997年成立了 MPLS 工作组，开发出一种新的协议——多协议标记交换 MPLS (MultiProtocol Label Switching)。</p><p>“多协议”表示在 MPLS 的上层可以采用多种协议，例如：IP，IPX；可以使用多种数据链路层协议，例如：PPP，以太网，ATM 等。</p><p>“标记”是指每个分组被打上一个标记，根据该标记对分组进行转发。</p></div><div><div><div style="text-align:center;color:#555;font-size:14px">-----------------------本文结束 <i class="fa fa-heart"></i> 感谢阅读-----------------------</div></div></div><div><div id="reward-container"><div>坚持原创技术分享，您的支持将鼓励我继续创作！恰饭^.^~</div><button id="reward-button" disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">打赏</button><div id="qr" style="display:none"><div style="display:inline-block"><img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/20190826214611.png" alt="峻源 微信支付"><p>微信支付</p></div><div style="display:inline-block"><img src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/20190826214431.png" alt="峻源 支付宝"><p>支付宝</p></div></div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者： </strong>峻源</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="http://lyxf2000.github.io/posts/724621c1/" title="计算机网络【五】">http://lyxf2000.github.io/posts/724621c1/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/posts/1dd8e486/" rel="next" title="计算机网络【四】"><i class="fa fa-chevron-left"></i> 计算机网络【四】</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/posts/17486a18/" rel="prev" title="计算机网络【六】">计算机网络【六】 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div></div><div class="comments" id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC80NjM0NC8yMjg1NQ=="></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><div class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><a href="/"><img class="site-author-image" itemprop="image" src="https://lyxf2000-1259802619.cos.ap-beijing.myqcloud.com/avatar.gif" alt="峻源"></a><p class="site-author-name" itemprop="name">峻源</p><div class="site-description motion-element" itemprop="description">乐于心，乐与心，乐之屿，心扉间</div></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">122</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">17</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">21</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="mailto:1194320636@qq.com" title="QE-Mail &rarr; mailto:1194320636@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-qq"></i>QE-Mail</a> </span><span class="links-of-author-item"><a href="https://music.163.com/#/playlist?id=699716432" title="CloudMusic &rarr; https://music.163.com/#/playlist?id=699716432" rel="noopener" target="_blank"><i class="fa fa-fw fa-music"></i>CloudMusic</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://www.baidu.com/" title="https://www.baidu.com/" rel="noopener" target="_blank">百度</a></li><li class="links-of-blogroll-item"><a href="https://www.google.com/?hl=zh_CN" title="https://www.google.com/?hl=zh_CN" rel="noopener" target="_blank">谷歌</a></li><li class="links-of-blogroll-item"><a href="https://www.zhihu.com/" title="https://www.zhihu.com/" rel="noopener" target="_blank">知乎</a></li><li class="links-of-blogroll-item"><a href="https://juejin.im/" title="https://juejin.im/" rel="noopener" target="_blank">掘金</a></li><li class="links-of-blogroll-item"><a href="https://github.com/" title="https://github.com/" rel="noopener" target="_blank">github</a></li><li class="links-of-blogroll-item"><a href="https://www.luogu.org/" title="https://www.luogu.org/" rel="noopener" target="_blank">洛谷</a></li></ul></div></div></div><div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4网际控制报文协议-ICMP"><span class="nav-number">1.</span> <span class="nav-text">4.4网际控制报文协议 ICMP</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-4-1ICMP-报文的种类"><span class="nav-number">1.1.</span> <span class="nav-text">4.4.1ICMP 报文的种类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-4-2ICMP-的应用举例"><span class="nav-number">1.2.</span> <span class="nav-text">4.4.2ICMP 的应用举例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-5互联网的路由选择协议"><span class="nav-number">2.</span> <span class="nav-text">4.5互联网的路由选择协议</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-5-1有关路由选择协议的几个基本概念"><span class="nav-number">2.1.</span> <span class="nav-text">4.5.1有关路由选择协议的几个基本概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-5-2-内部网关协议-RIP"><span class="nav-number">2.2.</span> <span class="nav-text">4.5.2 内部网关协议 RIP</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-5-3内部网关协议-OSPF"><span class="nav-number">2.3.</span> <span class="nav-text">4.5.3内部网关协议 OSPF</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-5-4-外部网关协议BGP"><span class="nav-number">2.4.</span> <span class="nav-text">4.5.4 外部网关协议BGP</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#三种协议的比较"><span class="nav-number">2.5.</span> <span class="nav-text">三种协议的比较</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-5-5-路由器的构成"><span class="nav-number">2.6.</span> <span class="nav-text">4.5.5 路由器的构成</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-6-IPv6"><span class="nav-number">3.</span> <span class="nav-text">4.6 IPv6</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-7-IP-多播"><span class="nav-number">4.</span> <span class="nav-text">4.7 IP 多播</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-7-1-IP-多播的基本概念"><span class="nav-number">4.1.</span> <span class="nav-text">4.7.1 IP 多播的基本概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-7-2-在局域网上进行硬件多播"><span class="nav-number">4.2.</span> <span class="nav-text">4.7.2 在局域网上进行硬件多播</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-7-3-网际组管理协议-IGMP-和多播路由选择协议"><span class="nav-number">4.3.</span> <span class="nav-text">4.7.3 网际组管理协议 IGMP 和多播路由选择协议</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-8虚拟专用网-VPN-和网络地址转换-NAT"><span class="nav-number">5.</span> <span class="nav-text">4.8虚拟专用网 VPN 和网络地址转换 NAT</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-8-1-虚拟专用网-VPN"><span class="nav-number">5.1.</span> <span class="nav-text">4.8.1 虚拟专用网 VPN</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-8-2-网络地址转换-NAT"><span class="nav-number">5.2.</span> <span class="nav-text">4.8.2 网络地址转换 NAT</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-9-多协议标记交换-MPLS"><span class="nav-number">6.</span> <span class="nav-text">4.9 多协议标记交换 MPLS</span></a></li></ol></div></div></div><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright">&copy; <span itemprop="copyrightYear">2021</span> <span class="with-love" id="heart"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">峻源</span></div><span>本站已运行<span id="showDays"></span></span><script>var seconds=1e3,minutes=60*seconds,hours=60*minutes,days=24*hours,years=365*days,birthDay=Date.UTC(2019,8,1,14,0,0);setInterval(function(){var e=new Date,s=e.getFullYear(),t=e.getMonth()+1,a=e.getDate(),o=e.getHours(),r=e.getMinutes(),n=e.getSeconds(),h=Date.UTC(s,t,a,o,r,n),u=h-birthDay,d=Math.floor(u/years),y=Math.floor(u/days-365*d),i=Math.floor((u-(365*d+y)*days)/hours),l=Math.floor((u-(365*d+y)*days-i*hours)/minutes),M=Math.floor((u-(365*d+y)*days-i*hours-l*minutes)/seconds);document.getElementById("showDays").innerHTML=""+d+"年"+y+"天"+i+"小时"+l+"分钟"+M+"秒"},1e3)</script><div><i class="fa fa-user-md"></i> <span id="busuanzi_container_site_uv">访问人数：<span id="busuanzi_value_site_uv"></span> </span>&nbsp;|&nbsp; <i class="fa fa-eye"></i> <span id="busuanzi_container_site_pv">总访问量：<span id="busuanzi_value_site_pv"></span> </span>&nbsp;|&nbsp; <i class="fa fa-pencil"></i> <span class="post-count">博客全站共 453.9k 字</span></div></div></footer></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script src="/lib/jquery/index.js?v=3.4.1"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/lib/fancybox/source/jquery.fancybox.pack.js"></script><script src="/js/utils.js?v=7.2.0"></script><script src="/js/motion.js?v=7.2.0"></script><script src="/js/affix.js?v=7.2.0"></script><script src="/js/schemes/pisces.js?v=7.2.0"></script><script src="/js/scrollspy.js?v=7.2.0"></script><script src="/js/post-details.js?v=7.2.0"></script><script src="/js/next-boot.js?v=7.2.0"></script><script>window.livereOptions={refer:"posts/724621c1/"},function(e,t){var n,r=e.getElementsByTagName(t)[0];"function"!=typeof LivereTower&&(n=e.createElement(t),n.src="https://cdn-city.livere.com/js/embed.dist.js",n.async=!0,r.parentNode.insertBefore(n,r))}(document,"script")</script><script>function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var e=$("#local-search-input");e.attr("autocapitalize","none"),e.attr("autocorrect","off"),e.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(e){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(e,t,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:e,dataType:isXml?"xml":"json",async:!0,success:function(e){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",e).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():e,r=document.getElementById(t),s=document.getElementById(o),a=function(){var e=r.value.trim().toLowerCase(),t=e.split(/[\s\-]+/);t.length>1&&t.push(e);var o=[];if(e.length>0&&n.forEach(function(n){function r(t,o,n,r){for(var s=r[r.length-1],a=s.position,i=s.word,l=[],h=0;a+i.length<=n&&0!=r.length;){i===e&&h++,l.push({position:a,length:i.length});var p=a+i.length;for(r.pop();0!=r.length&&(s=r[r.length-1],a=s.position,i=s.word,p>a);)r.pop()}return c+=h,{hits:l,start:o,end:n,searchTextCount:h}}function s(e,t){var o="",n=t.start;return t.hits.forEach(function(t){o+=e.substring(n,t.position);var r=t.position+t.length;o+='<b class="search-keyword">'+e.substring(t.position,r)+"</b>",n=r}),o+=e.substring(n,t.end)}var a=!1,i=0,c=0,l=n.title.trim(),h=l.toLowerCase(),p=n.content.trim().replace(/<[^>]+>/g,""),u=p.toLowerCase(),f=decodeURIComponent(n.url).replace(/\/{2,}/g,"/"),d=[],g=[];if(""!=l&&(t.forEach(function(e){function t(e,t,o){var n=e.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(t=t.toLowerCase(),e=e.toLowerCase());(s=t.indexOf(e,r))>-1;)a.push({position:s,word:e}),r=s+n;return a}d=d.concat(t(e,h,!1)),g=g.concat(t(e,u,!1))}),(d.length>0||g.length>0)&&(a=!0,i=d.length+g.length)),a){[d,g].forEach(function(e){e.sort(function(e,t){return t.position!==e.position?t.position-e.position:e.word.length-t.word.length})});var v=[];0!=d.length&&v.push(r(l,0,l.length,d));for(var $=[];0!=g.length;){var C=g[g.length-1],m=C.position,x=C.word,w=m-20,y=m+80;0>w&&(w=0),y<m+x.length&&(y=m+x.length),y>p.length&&(y=p.length),$.push(r(p,w,y,g))}$.sort(function(e,t){return e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hits.length!==t.hits.length?t.hits.length-e.hits.length:e.start-t.start});var T=parseInt("1");T>=0&&($=$.slice(0,T));var b="";b+=0!=v.length?"<li><a href='"+f+"' class='search-result-title'>"+s(l,v[0])+"</a>":"<li><a href='"+f+"' class='search-result-title'>"+l+"</a>",$.forEach(function(e){b+="<a href='"+f+'\'><p class="search-result">'+s(p,e)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:c,hitCount:i,id:o.length})}}),1===t.length&&""===t[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x"></i></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>';else{o.sort(function(e,t){return e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hitCount!==t.hitCount?t.hitCount-e.hitCount:t.id-e.id});var a='<ul class="search-result-list">';o.forEach(function(e){a+=e.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(e){e.stopPropagation(),isfetched===!1?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(e){e.stopPropagation()}),$(document).on("keyup",function(e){var t=27===e.which&&$(".search-popup").is(":visible");t&&onPopupClose()})</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><link rel="stylesheet" href="/dist/APlayer.min.css"><div id="aplayer"></div><script type="text/javascript" src="/dist/APlayer.min.js"></script><script type="text/javascript" src="/dist/music.js"></script><script type="text/javascript" src="/js/firework.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":220,"height":400},"mobile":{"show":false},"react":{"opacity":0.9},"log":false});</script></body></html><!-- rebuild by neat -->